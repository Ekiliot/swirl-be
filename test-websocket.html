<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; }
        .message { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { color: red; }
        .success { color: green; }
        input, button { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>WebSocket Test –¥–ª—è Chatroulette Backend</h1>
    
    <div>
        <h3>1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:</h3>
        <div style="margin: 10px 0;">
            <input type="text" id="username-input" placeholder="Username (3-20 —Å–∏–º–≤–æ–ª–æ–≤)" style="width: 200px;">
            <input type="password" id="password-input" placeholder="Password (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" style="width: 200px;">
            <button onclick="registerUser()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button onclick="loginUser()">–í–æ–π—Ç–∏</button>
        </div>
        <div style="font-size: 12px; color: #666; margin: 5px 0;">
            üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤–æ–π—Ç–∏ –∫–∞–∫ testuser
        </div>
        <div style="margin: 10px 0;">
            <button onclick="getToken()">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω (testuser)</button>
            <button onclick="createChat()">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
            <button onclick="findRandomUser()">–ù–∞–π—Ç–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
        <div id="token-info"></div>
    </div>
    
    <div>
        <h3>2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:</h3>
        <input type="text" id="token-input" placeholder="JWT Token" style="width: 300px;">
        <input type="text" id="chat-id-input" placeholder="Chat ID" style="width: 300px;">
        <button onclick="connectWebSocket()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket</button>
        <button onclick="disconnectWebSocket()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
    </div>
    
    <div>
        <h3>3. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:</h3>
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" style="width: 300px;">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
    </div>
    
    <div>
        <h3>–°–æ–æ–±—â–µ–Ω–∏—è:</h3>
        <div id="messages"></div>
    </div>

    <script>
        let ws = null;
        let currentToken = '';
        let currentChatId = '';

        async function registerUser() {
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ username –∏ password!');
                return;
            }
            
            if (username.length < 3) {
                document.getElementById('token-info').innerHTML = '<p class="error">Username –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞!</p>';
                return;
            }
            
            if (username.length > 20) {
                document.getElementById('token-info').innerHTML = '<p class="error">Username –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 20 —Å–∏–º–≤–æ–ª–æ–≤!</p>';
                return;
            }
            
            if (password.length < 6) {
                document.getElementById('token-info').innerHTML = '<p class="error">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤!</p>';
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    document.getElementById('token-input').value = currentToken;
                    document.getElementById('token-info').innerHTML = '<p class="success">‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "' + username + '" —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω! –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω.</p>';
                } else {
                    const errorData = await response.json();
                    if (response.status === 409) {
                        document.getElementById('token-info').innerHTML = '<p class="error">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username "' + username + '" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π username.</p>';
                    } else {
                        document.getElementById('token-info').innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                    }
                }
            } catch (error) {
                document.getElementById('token-info').innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message + '</p>';
            }
        }

        async function loginUser() {
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ username –∏ password!');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    document.getElementById('token-input').value = currentToken;
                    document.getElementById('token-info').innerHTML = '<p class="success">‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + username + '!</p>';
                } else {
                    const errorData = await response.json();
                    if (response.status === 401) {
                        document.getElementById('token-info').innerHTML = '<p class="error">‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π username –∏–ª–∏ –ø–∞—Ä–æ–ª—å! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>';
                    } else {
                        document.getElementById('token-info').innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</p>';
                    }
                }
            } catch (error) {
                document.getElementById('token-info').innerHTML = '<p class="error">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message + '</p>';
            }
        }

        async function getToken() {
            try {
                const response = await fetch('http://localhost:8080/api/v1/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'testuser', password: 'test123' })
                });
                const data = await response.json();
                currentToken = data.token;
                document.getElementById('token-input').value = currentToken;
                document.getElementById('token-info').innerHTML = '<p class="success">–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω!</p>';
            } catch (error) {
                document.getElementById('token-info').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + error.message + '</p>';
            }
        }

        async function createChat() {
            if (!currentToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
                return;
            }
            try {
                const response = await fetch('http://localhost:8080/api/v1/chats', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({ 
                        name: 'Test Chat', 
                        description: 'Test chat for WebSocket',
                        type: 'private'
                    })
                });
                const data = await response.json();
                currentChatId = data.id;
                document.getElementById('chat-id-input').value = currentChatId;
                document.getElementById('token-info').innerHTML += '<p class="success">–ß–∞—Ç —Å–æ–∑–¥–∞–Ω! ID: ' + currentChatId + '</p>';
            } catch (error) {
                document.getElementById('token-info').innerHTML += '<p class="error">–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞: ' + error.message + '</p>';
            }
        }

        async function findRandomUser() {
            if (!currentToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
                return;
            }
            try {
                const response = await fetch('http://localhost:8080/api/v1/chatroulette/find', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + currentToken }
                });
                const data = await response.json();
                currentChatId = data.chat_id;
                document.getElementById('chat-id-input').value = currentChatId;
                document.getElementById('token-info').innerHTML += '<p class="success">–ù–∞–π–¥–µ–Ω —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å! Chat ID: ' + currentChatId + '</p>';
            } catch (error) {
                document.getElementById('token-info').innerHTML += '<p class="error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message + '</p>';
            }
        }

        function connectWebSocket() {
            const token = document.getElementById('token-input').value;
            const chatId = document.getElementById('chat-id-input').value;
            
            if (!token || !chatId) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏ chat_id!');
                return;
            }

            // WebSocket –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
            // –ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä
            const wsUrl = `ws://localhost:8080/api/v1/ws?chat_id=${chatId}&token=${token}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('Connected to chat');
                addMessage('Connected to chat', 'success');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('New message:', data);
                addMessage('Message: ' + JSON.stringify(data, null, 2), 'message');
            };
            
            ws.onclose = function() {
                console.log('Disconnected from chat');
                addMessage('Disconnected from chat', 'error');
            };
            
            ws.onerror = function(error) {
                console.log('WebSocket error:', error);
                addMessage('WebSocket error: ' + error.message, 'error');
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage() {
            const message = document.getElementById('message-input').value;
            if (!message) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!');
                return;
            }
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API, –∞ –Ω–µ —á–µ—Ä–µ–∑ WebSocket
            sendMessageViaAPI(message);
        }

        async function sendMessageViaAPI(message) {
            const token = document.getElementById('token-input').value;
            const chatId = document.getElementById('chat-id-input').value;
            
            try {
                const response = await fetch(`http://localhost:8080/api/v1/chats/${chatId}/messages`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ 
                        type: 'text',
                        content: message
                    })
                });
                const data = await response.json();
                addMessage('Message sent via API: ' + JSON.stringify(data, null, 2), 'success');
                document.getElementById('message-input').value = '';
            } catch (error) {
                addMessage('Error sending message: ' + error.message, 'error');
            }
        }

        function addMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;
            messageDiv.textContent = new Date().toLocaleTimeString() + ': ' + text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>
