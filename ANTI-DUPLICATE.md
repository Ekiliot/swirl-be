# üö´ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Ç–æ–≤

## üéØ **–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –≤ —á–∞—Ç—Ä—É–ª–µ—Ç–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –°–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —á–∞—Ç—ã –º–µ–∂–¥—É –æ–¥–Ω–∏–º–∏ –∏ —Ç–µ–º–∏ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ü–ª–æ—Ö–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –∏–∑-–∑–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ:**

### **1. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á –≤ —á–∞—Ç—Ä—É–ª–µ—Ç–∫–µ:**
```go
// –í search_queue.go
func (h *SearchQueueHandler) CheckExistingChat(userID1, userID2 string) (bool, error) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    var count int64
    err = h.db.Model(&models.Chat{}).
        Joins("JOIN chat_users cu1 ON chats.id = cu1.chat_id").
        Joins("JOIN chat_users cu2 ON chats.id = cu2.chat_id").
        Where("chats.type = ? AND cu1.user_id = ? AND cu2.user_id = ? AND cu1.user_id != cu2.user_id", 
            models.ChatTypeSaved, userUUID1, userUUID2).
        Count(&count).Error

    return count > 0, err
}
```

### **2. –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```go
// –í chatroulette.go
func (h *ChatrouletteHandler) findRandomUserWithoutExistingChat(currentUserID string) (*models.SearchQueue, error) {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
    var allUsers []models.SearchQueue
    h.db.Where("user_id != ?", currentUserID).Find(&allUsers)

    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —É–∂–µ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç
    var availableUsers []models.SearchQueue
    for _, user := range allUsers {
        hasExistingChat, err := h.searchHandler.CheckExistingChat(currentUserID, user.UserID.String())
        if err == nil && !hasExistingChat {
            availableUsers = append(availableUsers, user)
        }
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
    return &availableUsers[rand.Intn(len(availableUsers))], nil
}
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–∞—Ç–∞:**
```go
// –í SaveChat —Ñ—É–Ω–∫—Ü–∏–∏
if otherUserID != "" {
    hasExistingChat, err := h.searchHandler.CheckExistingChat(userID, otherUserID)
    if err == nil && hasExistingChat {
        c.JSON(http.StatusConflict, gin.H{"error": "A saved chat already exists between these users"})
        return
    }
}
```

## üîÑ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞**
1. **–í–∞—Å—è** –∏ **–ú–∞—à–∞** –∏—â—É—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
2. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –∏—Ö –¥—Ä—É–≥ –¥–ª—è –¥—Ä—É–≥–∞ ‚úÖ
3. –û–Ω–∏ –æ–±—â–∞—é—Ç—Å—è –∏ –º–æ–≥—É—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–∞—Ç
4. –ß–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –ª–∏—á–Ω—ã–π ‚úÖ

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)**
1. **–í–∞—Å—è** —Å–Ω–æ–≤–∞ –∏—â–µ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
2. **–ú–∞—à–∞** —Ç–æ–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–∏—Å–∫–∞
3. ‚ùå **–°–∏—Å—Ç–µ–º–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç –ú–∞—à—É** - —É –Ω–∏—Ö —É–∂–µ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç
4. –í–∞—Å—è –Ω–∞—Ö–æ–¥–∏—Ç **–¥—Ä—É–≥–æ–≥–æ** —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ‚úÖ

### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ø—ã—Ç–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**
1. **–í–∞—Å—è** –∏ **–ú–∞—à–∞** –≤ —á–∞—Ç—Ä—É–ª–µ—Ç–∫–µ
2. **–í–∞—Å—è** –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–∞—Ç
3. ‚ùå **–û—à–∏–±–∫–∞ 409**: "A saved chat already exists between these users"
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"

## üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**

### **–ù–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–∏—Å–∫–∞:**
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —á–∞—Ç–∞–º–∏
- ‚úÖ –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ "–Ω–æ–≤—ã—Ö" —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### **–ù–∞ —É—Ä–æ–≤–Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- ‚úÖ HTTP 409 Conflict –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### **–ù–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å JOIN
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

## üìä **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

### **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- üéØ **–ù–æ–≤—ã–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞** - –≤—Å–µ–≥–¥–∞ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –ª—é–¥—å–º–∏
- üíæ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - –æ–¥–∏–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç –Ω–∞ –ø–∞—Ä—É
- üöÄ **–õ—É—á—à–∏–π –æ–ø—ã—Ç** - —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤ –æ–±—â–µ–Ω–∏–∏

### **–î–ª—è —Å–∏—Å—Ç–µ–º—ã:**
- ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- üõ°Ô∏è **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** - –Ω–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### **SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT COUNT(*) FROM chats 
JOIN chat_users cu1 ON chats.id = cu1.chat_id
JOIN chat_users cu2 ON chats.id = cu2.chat_id
WHERE chats.type = 'saved' 
  AND cu1.user_id = ? 
  AND cu2.user_id = ? 
  AND cu1.user_id != cu2.user_id
```

### **–ê–ª–≥–æ—Ä–∏—Ç–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
3. –ò—Å–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö, —Å –∫–µ–º —É–∂–µ –µ—Å—Ç—å —á–∞—Ç
4. –í—ã–±—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- **409 Conflict** - —á–∞—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- **404 Not Found** - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **500 Internal Server Error** - –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

**–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:**
- üéØ **–í—Å–µ–≥–¥–∞ –≤—Å—Ç—Ä–µ—á–∞—é—Ç –Ω–æ–≤—ã—Ö –ª—é–¥–µ–π** –≤ —á–∞—Ç—Ä—É–ª–µ—Ç–∫–µ
- üíæ **–ù–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —á–∞—Ç—ã**
- üöÄ **–ü–æ–ª—É—á–∞—é—Ç –ª—É—á—à–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**
- üõ°Ô∏è **–ó–∞—â–∏—â–µ–Ω—ã –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–π**

**–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞ —É–º–Ω–µ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ!** üß†‚ú®
